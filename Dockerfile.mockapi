# Mock API Dockerfile
FROM node:18

# 작업 디렉토리 설정
WORKDIR /app

# 필수 패키지 설치 (git 포함)
RUN apt-get update && apt-get install -y git

# GitHub에서 프로젝트 코드 체크아웃
RUN git clone https://github.com/zerosial/mock_api_ai.git /app

# 한국 시간대로 설정
RUN ln -sf /usr/share/zoneinfo/Asia/Seoul /etc/localtime

# npm 패키지 설치
RUN npm install

# Prisma 클라이언트 생성
RUN npx prisma generate

# 환경변수 기본값 (런타임에서 docker-compose로 오버라이드 가능)
ENV NODE_ENV=production
ENV NEXT_PUBLIC_BASE_PATH=/mockapi
ENV OPENAI_API_KEY=dummy-key-for-build
ENV DATABASE_URL=postgresql://dummy:dummy@localhost:5432/dummy

# Next.js 빌드
RUN npm run build

# standalone 모드에서 필요한 정적 자원들을 올바른 위치로 복사
RUN cp -r .next/static .next/standalone/.next/static
RUN cp -r .next/server .next/standalone/.next/server
RUN cp -r public .next/standalone/public

# 포트 설정
EXPOSE 3000
ENV PORT=3000
ENV HOSTNAME=0.0.0.0

# 컨테이너 시작 시 Postgres 대기 후 마이그레이션 적용, Next standalone 서버 실행
CMD ["bash", "-lc", "until </dev/tcp/postgres-container/5432; do echo 'Postgres 대기 중...'; sleep 1; done; echo 'Postgres 준비 완료'; npx prisma migrate deploy && node .next/standalone/server.js"]