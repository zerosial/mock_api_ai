# Mock API Dockerfile
FROM node:18

# 작업 디렉토리 설정
WORKDIR /app

# 시스템 패키지 업데이트
RUN apt-get update && apt-get install -y \
    curl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /tmp/* \
    && rm -rf /var/tmp/*

# 한국 시간대로 설정
ENV TZ=Asia/Seoul
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# 애플리케이션 소스 코드 복사
COPY . .

# npm 패키지 설치 (빌드에 필요한 devDependencies 포함)
RUN npm install

# Prisma 클라이언트 생성
RUN npx prisma generate

# 환경변수 기본값 (런타임에서 docker-compose로 오버라이드 가능)
ENV NODE_ENV=production
ENV NEXT_PUBLIC_BASE_PATH=/mockapi
ENV OPENAI_API_KEY=dummy-key-for-build
ENV DATABASE_URL=postgresql://dummy:dummy@localhost:5432/dummy
ENV LLM_SERVICE_URL=http://local-llm-container:8000

# Next.js 빌드
RUN npm run build

# standalone 모드에서 필요한 정적 자원들을 올바른 위치로 복사
RUN cp -r .next/static .next/standalone/.next/static
RUN cp -r .next/server .next/standalone/.next/server
RUN cp -r public .next/standalone/public

# 포트 설정
EXPOSE 3000
ENV PORT=3000
ENV HOSTNAME=0.0.0.0

# 헬스체크 추가
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:3000/api/llm/health || exit 1

# 컨테이너 시작 시 Postgres 대기 후 마이그레이션 적용, Next standalone 서버 실행
CMD ["bash", "-lc", "until </dev/tcp/postgres-container/5432; do echo 'Postgres 대기 중...'; sleep 1; done; echo 'Postgres 준비 완료'; npx prisma migrate reset --force && npx prisma migrate deploy && node .next/standalone/server.js"]