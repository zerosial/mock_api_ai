# Local LLM Service Dockerfile (Optimized for Low-Spec)
FROM python:3.11-slim

# 작업 디렉토리 설정
WORKDIR /app

# 시스템 패키지 업데이트 및 필수 패키지 설치 (저사양 환경 최적화)
# - libgomp1: PyTorch/OpenMP 의존성(없으면 일부 환경에서 실행 실패 가능)
RUN apt-get update && apt-get install -y \
    curl \
    git \
    libgomp1 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /tmp/* \
    && rm -rf /var/tmp/*

# ===== 핵심 ENV =====
# EXAONE 4.0 같은 커스텀 아키텍처(exaone4) 로딩에 필수
ENV TRANSFORMERS_TRUST_REMOTE_CODE=1
# 대형 모델 다운로드 최적화(선택: 있으면 빠르고 안정적)
# ENV HF_HUB_ENABLE_HF_TRANSFER=1
ENV HF_HUB_ENABLE_HF_TRANSFER=0

# 출력 버퍼링 방지(로그 바로 표시)
ENV PYTHONUNBUFFERED=1
# 로케일/UTF-8 한글 로그 안전
ENV PYTHONIOENCODING=UTF-8

# Python 의존성 설치
COPY requirements-llm.txt .
RUN pip install --no-cache-dir -r requirements-llm.txt

# 한국 시간대 설정
ENV TZ=Asia/Seoul
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# 모델 저장 디렉토리 및 로그 디렉토리 생성
RUN mkdir -p /app/models /tmp

# 애플리케이션 코드 복사
COPY llm-service/ .

# 포트 설정
EXPOSE 8000

# 헬스체크 스크립트에 실행 권한 부여
RUN chmod +x /app/health_check.sh

# 헬스체크 (첫 진입 후 1시간 간격)
# 30초마다 스크립트 실행하되, 스크립트 내부에서 1시간 간격 관리
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD /app/health_check.sh

# 서비스 시작
CMD ["python", "main.py"]